<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice MRN/Template Detection Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">Voice MRN & Template Detection Test</h1>

    <div class="bg-gray-800 p-6 rounded-lg mb-6">
      <h2 class="text-xl font-semibold mb-4">Controls</h2>
      <div class="flex gap-4">
        <button id="startBtn" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded">
          Start Listening
        </button>
        <button id="stopBtn" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded">
          Stop Listening
        </button>
        <button id="resetBtn" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded">
          Reset Detection
        </button>
      </div>
      <div id="status" class="mt-4 text-gray-400">
        Status: Not listening
      </div>
    </div>

    <div class="bg-gray-800 p-6 rounded-lg mb-6">
      <h2 class="text-xl font-semibold mb-4">Test Instructions</h2>
      <div class="space-y-2 text-gray-300">
        <p>Try saying one of these examples:</p>
        <ul class="list-disc list-inside space-y-1">
          <li>"This is patient MRN AB123 for a SOAP note"</li>
          <li>"MRN-ABA121 needs an admission note"</li>
          <li>"Create a consultation note for MRN 0001ABC"</li>
          <li>"Patient MRN-0178HGR requires a discharge summary"</li>
          <li>"Telehealth visit for MRN AB456"</li>
        </ul>
      </div>
    </div>

    <div class="bg-gray-800 p-6 rounded-lg mb-6">
      <h2 class="text-xl font-semibold mb-4">Live Transcript</h2>
      <div id="transcript" class="bg-gray-900 p-4 rounded min-h-[100px] font-mono text-sm">
        Waiting for speech...
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div class="bg-gray-800 p-6 rounded-lg">
        <h2 class="text-xl font-semibold mb-4">Detected MRN</h2>
        <div id="detectedMrn" class="bg-gray-900 p-4 rounded text-2xl font-bold text-green-400">
          None
        </div>
      </div>

      <div class="bg-gray-800 p-6 rounded-lg">
        <h2 class="text-xl font-semibold mb-4">Detected Template</h2>
        <div id="detectedTemplate" class="bg-gray-900 p-4 rounded text-2xl font-bold text-blue-400">
          None
        </div>
      </div>
    </div>

    <div class="bg-gray-800 p-6 rounded-lg mt-6">
      <h2 class="text-xl font-semibold mb-4">Detection Log</h2>
      <div id="log" class="bg-gray-900 p-4 rounded max-h-[300px] overflow-y-auto font-mono text-xs">
        <div class="text-gray-500">Log will appear here...</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { VoiceController } from '/public/js/voice.js';

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resetBtn = document.getElementById('resetBtn');
    const status = document.getElementById('status');
    const transcript = document.getElementById('transcript');
    const detectedMrn = document.getElementById('detectedMrn');
    const detectedTemplate = document.getElementById('detectedTemplate');
    const log = document.getElementById('log');

    let transcriptText = '';

    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const colors = {
        info: 'text-gray-300',
        success: 'text-green-400',
        warning: 'text-yellow-400',
        error: 'text-red-400'
      };

      const entry = document.createElement('div');
      entry.className = colors[type] || colors.info;
      entry.textContent = `[${timestamp}] ${message}`;

      if (log.firstChild?.classList?.contains('text-gray-500')) {
        log.innerHTML = '';
      }

      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }

    // Check browser support
    if (!VoiceController.isAvailable()) {
      addLog('Speech recognition is NOT supported in this browser', 'error');
      status.textContent = 'Status: Speech recognition not supported';
      startBtn.disabled = true;
      startBtn.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
      addLog('Speech recognition is available', 'success');
    }

    const voiceController = new VoiceController({
      lang: 'en-US',
      continuous: true,
      interimResults: true,
      onMRNTemplateDetected: (data) => {
        addLog(`âœ“ DETECTION: MRN=${data.mrn}, Template=${data.template}`, 'success');

        if (data.mrn) {
          detectedMrn.textContent = data.mrn;
          detectedMrn.classList.add('animate-pulse');
          setTimeout(() => detectedMrn.classList.remove('animate-pulse'), 1000);
        }

        if (data.template) {
          detectedTemplate.textContent = data.template;
          detectedTemplate.classList.add('animate-pulse');
          setTimeout(() => detectedTemplate.classList.remove('animate-pulse'), 1000);
        }
      },
      onTranscript: (text, isFinal) => {
        if (isFinal) {
          transcriptText += (transcriptText ? ' ' : '') + text;
          transcript.textContent = transcriptText;
          addLog(`Final: "${text}"`, 'info');
        } else {
          transcript.textContent = transcriptText + (transcriptText ? ' ' : '') + text + '...';
        }
      },
      onListenStateChange: (isListening) => {
        if (isListening) {
          status.textContent = 'Status: Listening...';
          status.classList.add('text-green-400');
          status.classList.remove('text-gray-400', 'text-red-400');
          addLog('Started listening', 'success');
        } else {
          status.textContent = 'Status: Not listening';
          status.classList.add('text-gray-400');
          status.classList.remove('text-green-400', 'text-red-400');
          addLog('Stopped listening', 'warning');
        }
      },
      onError: (error) => {
        addLog(`Error: ${error}`, 'error');
        status.textContent = `Status: Error - ${error}`;
        status.classList.add('text-red-400');
        status.classList.remove('text-gray-400', 'text-green-400');
      }
    });

    startBtn.addEventListener('click', () => {
      const started = voiceController.start();
      if (started) {
        addLog('Voice recognition started', 'success');
      } else {
        addLog('Failed to start voice recognition', 'error');
      }
    });

    stopBtn.addEventListener('click', () => {
      voiceController.stop();
      addLog('Voice recognition stopped', 'warning');
    });

    resetBtn.addEventListener('click', () => {
      voiceController.resetDetection();
      transcriptText = '';
      transcript.textContent = 'Waiting for speech...';
      detectedMrn.textContent = 'None';
      detectedTemplate.textContent = 'None';
      log.innerHTML = '<div class="text-gray-500">Log cleared...</div>';
      addLog('Detection reset', 'info');
    });

    window.voiceController = voiceController;
  </script>
</body>
</html>
